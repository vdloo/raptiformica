#!/bin/bash
export PYTHONPATH=../

SPAWN_ENTRYPOINT="raptiformica_spawn.py"
PACKAGE_ENTRYPOINT="raptiformica_package.py"
PRUNE_ENTRYPOINT="raptiformica_prune.py"
DESTROY_ENTRYPOINT="raptiformica_destroy.py"
MEMBERS_ENTRYPOINT="raptiformica_members.py"
SLAVE_ENTRYPOINT="raptiformica_slave.py"
MODPROBE_ENTRYPOINT="raptiformica_modprobe.py"
SSH_ENTRYPOINT="raptiformica_ssh.py"
INJECT_ENTRYPOINT="raptiformica_inject.py"

function print_help {
    cat <<'END'
Usage: raptiformica [CMD..] [OPTIONS] [-h]

  spawn                      Spawn a machine to slave and 
                             assimilate into the network

  slave                      Provision and join a machine 
                             into the network

  package                    Package a machine into a
                             reusable image

  prune                      Clean up inactive instances

  destroy                    Destroy cluster, clean up cache.

  modprobe                   Load or unload a module into
                             the system

  inject                     Add a host to the local meshnet 
                             configuration.

  members                    Show the members of the 
                             distributed network.

  ssh                        SSH into one of the machines
END
}

case $1 in 
    spawn)
    RAPTIFORMICA_CMD=$SPAWN_ENTRYPOINT
    shift 
    ;;
    prune)
    RAPTIFORMICA_CMD=$PRUNE_ENTRYPOINT
    shift
    ;;
    destroy)
    RAPTIFORMICA_CMD=$DESTROY_ENTRYPOINT
    shift
    ;;
    ssh)
    RAPTIFORMICA_CMD=$SSH_ENTRYPOINT
    shift
    ;;
    members)
    RAPTIFORMICA_CMD=$MEMBERS_ENTRYPOINT
    shift
    ;;
    slave)
    RAPTIFORMICA_CMD=$SLAVE_ENTRYPOINT
    shift
    ;;
    modprobe)
    RAPTIFORMICA_CMD=$MODPROBE_ENTRYPOINT
    shift
    ;;
    inject)
    RAPTIFORMICA_CMD=$INJECT_ENTRYPOINT
    shift
    ;;
    package)
    RAPTIFORMICA_CMD=$PACKAGE_ENTRYPOINT
    shift
    ;;
    *)
    print_help;
    exit 1
    ;;
esac

ENTRYPOINT_SCRIPT_PATH=$(readlink -f "$0")
RAPTIFORMICA_BIN_DIRECTORY=$(dirname "$ENTRYPOINT_SCRIPT_PATH")
RAPTIFORMICA_DIRECTORY=$(dirname "$RAPTIFORMICA_BIN_DIRECTORY")

export PYTHONPATH=$RAPTIFORMICA_DIRECTORY
$RAPTIFORMICA_BIN_DIRECTORY/$RAPTIFORMICA_CMD $@
